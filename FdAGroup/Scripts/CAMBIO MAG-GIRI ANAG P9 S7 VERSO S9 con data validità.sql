--//###########################################################################
--// ZONE INTERESSATE DAL PASSAGGIO IN DATA  01/02/2019
--// dai magazzini P9 e S7 al Nuovo Magazzino S9 A PARTIRE DAL 01/02/2019
--//###########################################################################
--// NOTA BENE NOTA BENE NOTA BENE NOTA BENE NOTA BENE NOTA BENE NOTA BENE 
--// TUTTI I PVE INTERESSATI SONO SALVATI NELLA TABELLA CED.NEWCLIS9 
--// RICEVUTA DA GIOVANNI IL 12/01/2019
--// NOTA BENE NOTA BENE NOTA BENE NOTA BENE NOTA BENE NOTA BENE NOTA BENE 

-- 0000000000000000000000000000000000000000000000000000000000000000000000000000
-- 0000000000000000000000000000000000000000000000000000000000000000000000000000

--// ESTRAZIONE DI TUTTE LE SERIE GIRI USATE NEI DEPOSITI
--// DI PARTENZA 
DELETE FROM CED.TABEL00FSV

INSERT INTO CED.TABEL00FSV 
(
SELECT * FROM SMEDAT_TS2.TABEL00F 
WHERE TTSETT = 'XGI' 
AND LEFT(TTLIBE, 3) IN ('P9', 'S7')
)

--// VISUALIZZAZIONE GIRI SALVATI
select TTELEM Giro, 
       TTDESC Descrizione, 
       left(TTLIBE, 3) Mag, 
       substr(TTLIBE, 4, 1) Giorno,
       substr(TTLIBE, 5, 3) Vettore1,
       substr(TTLIBE, 8, 3) Vettore2,
       substr(TTLIBE, 11, 1) "Viaggi sep.x cliente",
       substr(TTLIBE, 12, 1) "Genera token cliente",
       substr(TTLIBE, 13, 1)  "Priorità raggrupp.",
       substr(TTLIBE, 14, 1) "Attr.vis.monitor",
       substr(TTLIBE, 15, 3)  "Modalità di spedizione",
       substr(TTLIBE, 18, 3) "Modalità di consegna",
       substr(TTLIBE, 21, 1) "Escluso pianif. viaggi",
       substr(TTLIBE, 22, 2) "Area di preparazione",
       substr(TTLIBE, 24, 1) "Tipo ordine Systore",
       substr(TTLIBE, 25, 2) "Disabil.Accorp.autom.",
       substr(TTLIBE, 26, 2) "Tipo giro"
FROM CED.TABEL00FSV

--// CAMBIO PREFISSO MAGAZZINO SU CODICE GIRO 
--// E MAGAZZINO ASSEGNATO LASCIANDO INALTERATO IL RESTO
--// NEL CASO SI POSSONO AGGIORNARE I VETTORI USANDO 
--// LA STESSA SINTASSI
UPDATE CED.TABEL00FSV
SET TTELEM='S9'||SUBSTR(TTELEM, 3, 3)    -- Aggiornamento prefisso Magazzino
  
UPDATE CED.TABEL00FSV
SET TTLIBE='S9 '||SUBSTR(TTLIBE, 4, 96) -- Aggiornamento Magazzino associato al giro


-- CARICO I RECORD ELIMINANDO I RECORD DOPPI
INSERT INTO SMEDAT_TS2.TABEL00F (
TTANNU , TTSETT , TTELEM , TTDESC , TTLIBE , TTUSER ,
TTFL01 , TTFL02 , TTFL03 , TTFL04 , TTFL05 , TTFL06 ,
TTFL07 , TTFL08 , TTFL09 , TTFL10 , TTFL11 , TTFL12 ,
TTFL13 , TTFL14 , TTFL15 , TTFL16 , TTFL17 , TTFL18 ,  TTFL19 , TTFL20 ,
TTUSIN , TTDTIN , TTORIN , TTUSAG , TTDTAG , TTORAG
)

WITH A AS
(
	SELECT B.* , 
        ROW_NUMBER() OVER (PARTITION BY TTELEM ORDER BY TTELEM DESC) AS RN
	FROM CED.TABEL00FSV AS B
)

SELECT 
TTANNU , TTSETT , TTELEM , TTDESC , TTLIBE , TTUSER ,
TTFL01 , TTFL02 , TTFL03 , TTFL04 , TTFL05 , TTFL06 ,
TTFL07 , TTFL08 , TTFL09 , TTFL10 , TTFL11 , TTFL12 ,
TTFL13 , TTFL14 , TTFL15 , TTFL16 , TTFL17 , TTFL18 , TTFL19 , TTFL20 ,
TTUSIN , TTDTIN , TTORIN , TTUSAG , TTDTAG , TTORAG 
FROM A WHERE RN = 1


-- 1111111111111111111111111111111111111111111111111111111111111111111111111111
-- 1111111111111111111111111111111111111111111111111111111111111111111111111111

--//#######################################################################
--// CAMBIO GIRI   CAMBIO GIRI   CAMBIO GIRI   CAMBIO GIRI   CAMBIO GIRI  
--//#######################################################################

-- PULIZIA TABELLA TEMPORANEA DOVE SALVARE I GIRI ASSGNATI AI PVE DA SPOSTARE

DELETE   FROM CED.C£CONR0FS9

COMMIT

--// SALVATAGGIO DEI DATI NELLA LIBRERIA CED
SELECT COUNT(*) FROM CED.C£CONR0FS9
SELECT * FROM CED.C£CONR0FS9


--// COPIO IN UN FILE DI APPOGGIO TUTTI I GIRI DELLE ZONE SELEZIONATE 
INSERT INTO CED.C£CONR0FS9  
(
SELECT * FROM SMEDAT_TS2.C£CONR0F 
WHERE  LEFT(C£NUMP, 2)='GC'
AND ( LEFT(C£CDVA, 2)='P9' OR LEFT(C£CDVA, 2)='S7' )
AND C£TPRC='PVE'  
AND C£CD01 IN 
(
SELECT E§CRAG FROM SMEDAT_TS2.BRENTI0F WHERE E§TRAG='PVE' 
AND ( E§COD1='P9' OR E§COD1='S7' ) 
--AND  E§LIVE='2'  --  passo anche clienti vecchi 
AND E§DINV <= YEAR(CURRENT_DATE)*10000
                  + MONTH(CURRENT_DATE)*100
                  + DAY(CURRENT_DATE) 
AND E§DFNV >= YEAR(CURRENT_DATE)*10000
                  + MONTH(CURRENT_DATE)*100
                  + DAY(CURRENT_DATE)      
AND E§ZONA IN (
-- ( 
	  '020' -- Montalbini Marco                   
	, '051' -- Gresta Giordano              
	, '101' -- Forti Mario              
	, '129' -- Parlani Andrea             
	, '232' -- Raduazzo Alessandro            
	, '380' -- Donati Maurizio           
-- )
)
)
AND C£CD01 IN  (SELECT CDPVE FROM CED.NEWCLIS9)
)


SELECT DISTINCT C£CDVA FROM CED.C£CONR0FS9

--// SELECT * FROM CED.C£CONR0FS9
--// CAMBIO GIRO PER TUTTI I PVE INTERESSATI
--// SOSTITUENDO IL PREFISSO 'P9' or 'S9' CON 'S7'
UPDATE CED.C£CONR0FS9  
SET    C£CDVA = 'S9'|| SUBSTRING(C£CDVA , 3 , 3) 
 , C£DTAG=20190116
 , C£ORAG=163000
 , C£USAG='EDP01SQL' 

--// CARICO I NUOVI DATI SULLA TABELLA DI PRODUZIONE
INSERT INTO SMEDAT_TS2.C£CONR0F
(SELECT * FROM CED.C£CONR0FS9 )

--// VERIFICA AGGIORNAMENTO GIRI
SELECT  *  FROM SMEDAT_TS2.C£CONR0F 
WHERE  LEFT(C£NUMP, 2)='GC'
AND LEFT(C£CDVA, 2)='S9'
AND C£DTAG=20190116
AND C£USAG='EDP01SQL'
ORDER BY C£NUMP 

-- 222222222222222222222222222222222222222222222222222222222222222222222222222
-- 222222222222222222222222222222222222222222222222222222222222222222222222222

  
--//##########################################################################
--// CAMBIO MAG  CAMBIO MAG  CAMBIO MAG  CAMBIO MAG  CAMBIO MAG  CAMBIO MAG  
--// SU ANAGRAFICA PVE          
--//##########################################################################

--// ATTENZIONE CHE PER AVERE L'RRN CHE PARTE DA 1 USARE IL COMANDO CLRPFM
--// CLRPFM CED/WORKBRS9    


SELECT * FROM CED.WORKBRS9	


-- STEP 1 STEP 1 STEP 1 STEP 1 STEP 1 STEP 1 
-- COPIA RECORD DA AGGIORNARE NELLA TABELLA CED/WORKBRS9
INSERT INTO CED.WORKBRS9
(
SELECT * FROM SMEDAT_TS2.BRENTI0F 
WHERE E§TRAG='PVE' 
AND ( E§CRAG IN (SELECT CDPVE FROM CED.NEWCLIS9) )    
AND E§DINV <= YEAR(CURRENT_DATE)*10000
                  + MONTH(CURRENT_DATE)*100
                  + DAY(CURRENT_DATE) 
AND E§DFNV >= YEAR(CURRENT_DATE)*10000
                  + MONTH(CURRENT_DATE)*100
                  + DAY(CURRENT_DATE)      
AND E§ZONA IN (
-- ( 
	  '020' -- Montalbini Marco                   
	, '051' -- Gresta Giordano              
	, '101' -- Forti Mario              
	, '129' -- Parlani Andrea             
	, '232' -- Raduazzo Alessandro            
	, '380' -- Donati Maurizio           
-- )
)
)

-- STEP 2 STEP 2 STEP 2 STEP 2 STEP 2 STEP 2 
-- UPDATE CODICE MAGAZZINO 
UPDATE CED.WORKBRS9
SET E§COD1='S9'

-- STEP 3 STEP 3 STEP 3 STEP 3 STEP 3 STEP 3 
-- UPDATE WORKBRS9 CON NUOVA DATA VALIDITA' 
-- E NUOVO VALORE CERCATO 
UPDATE CED.WORKBRS9  
SET E§DINV=20190201, 
E§DFNV=99991231,
E§ORAG=165000, 
E§DTAG=20190116, 
E§USAG='EDP01SQL'


-- STEP 4 STEP 4 STEP 4 STEP 4 STEP 4 STEP 4
-- AGGIORNAMENTO RECORD ORIGINE CON DATA FINE VALIDITA'
UPDATE SMEDAT_TS2.BRENTI0F
SET E§DFNV=20190131,
E§DTAG=20190116, 
E§USAG='EDP01SQL'
WHERE E§IDOJ IN (SELECT E§IDOJ FROM CED.WORKBRS9)


--  VERIFICA DELL'UPDATE
SELECT * FROM SMEDAT_TS2.BRENTI0F
WHERE  E§DFNV=20190131 AND
E§DTAG=20190116 AND
E§USAG='EDP01SQL'


COMMIT


-- STEP 5 STEP 5 STEP 5 STEP 5 STEP 5 STEP 5 
-- LETTURA ULTIMO NUMERATORE ID IN SMEDAT_TS2.BRENTI0F 
-- TABELLA CRN SS BR 
SELECT SUBSTRING(TTLIBE, 13, 10) FROM SMEDAT_TS2.TABEL00F 
WHERE TTSETT='CRNBR' 
AND TTELEM='OG.BRENTI'
--VALORE TROVATO 0004121893

-- STEP 6 STEP 6 STEP 6 STEP 6 STEP 6 STEP 6 
-- AGGIORNAMENTO CAMPO IDOJ PER NUOVI RECORD DA CARICARE
UPDATE CED.WORKBRS9 A
SET E§IDOJ= RRN(A) + 0004121899

-- SECONDO PASSAGGIO PER FORMATTARE IL CAMPO CORRETTAMENTE
UPDATE CED.WORKBRS9 A
SET E§IDOJ=SUBSTRING(DIGITS(E§IDOJ), 23, 10)

-- ULTIMO NUMERO IDOJ SCRITTO
SELECT MAX(E§IDOJ) FROM CED.WORKBRS9


SELECT MAX(E§IDOJ) FROM SMEDAT_TS2.BRENTI0F  
WHERE E§TRAG<>'AZI' 

SELECT * FROM  SMEDAT_TS2.BRENTI0F 
WHERE E§IDOJ=9999999999
-- STEP 7 STEP 7 STEP 7 STEP 7 STEP 7 STEP 7 
-- AGGIORNAMENTO NUMERATORE CRNBR(OG.BRENTI) 
-- CON IL MAX VALORE TROVATO AL PUNTO 6
-- QUI È MEGLIO FARLO A MANINA


-- STEP 8 STEP 8 STEP 8 STEP 8 STEP 8 STEP 8 
-- INSERT DI WORKBRS7 IN BRENTI0F
INSERT INTO SMEDAT_TS2.BRENTI0F 
SELECT * FROM CED.WORKBRS9

-- Verifica aggiornamento STEP 8
SELECT * FROM SMEDAT_TS2.BRENTI0F 
WHERE E§TRAG='PVE' 
AND ( E§CRAG IN (SELECT CDPVE FROM CED.NEWCLIS9) )    
AND E§DINV <= YEAR(CURRENT_DATE)*10000
                  + MONTH(CURRENT_DATE)*100
                  + DAY(CURRENT_DATE) 
AND E§DFNV >= YEAR(CURRENT_DATE)*10000
             + MONTH(CURRENT_DATE)*100
             + DAY(CURRENT_DATE) 
AND E§ZONA IN (
-- ( 
	  '020' -- Montalbini Marco                   
	, '051' -- Gresta Giordano              
	, '101' -- Forti Mario              
	, '129' -- Parlani Andrea             
	, '232' -- Raduazzo Alessandro            
	, '380' -- Donati Maurizio           
-- )
)

--VERIFICA CHE NON CI SIANO NUMERATORI DOPPI
SELECT E§IDOJ FROM SMEDAT_TS2.BRENTI0F
GROUP BY E§IDOJ HAVING COUNT(E§IDOJ)>1


--// AGGIORNAMENTO MAGAZZINO SU ZONE in P9
--// ATTENZIONE CHE QUESTA MODIFICA VA FATTA IL GIORNO 1/02/19
UPDATE SMEDAT_TS2.TABEL00F                    
SET TTUSER=LEFT(TTUSER, 25)||'S9'||SUBSTR(TTUSER, 28, 73)
WHERE TTSETT='ZON' 
--  AND SUBSTR(TTUSER, 26, 2)='P9'
AND TTELEM IN  (
-- ( 
	  '101' -- Forti Mario               *
	, '129' -- Parlani Andrea            *
	, '380' -- Donati Maurizio           *
-- )
)


	

