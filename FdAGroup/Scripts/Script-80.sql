
WITH CLICOM AS (
SELECT 'LIZ' COMPANY,
    E§TRAG,	E§CRAG,	E§NMNE , 
    --E§AZIE,	
    E§DINV, E§DFNV,	--E§LIVE,	
    E§RAGS, E§STAT,	E§ZONA,
    (SELECT LEFT(TTELEM, 5)||TTDESC FROM SMEDATLIZ.TABEL00F WHERE TTSETT='PAG' AND TTELEM=E§COPA) PAGAMENTO,  E§LIST LISTINO, 
    (SELECT LEFT(TTELEM, 5)||TTDESC FROM SMEDATLIZ.TABEL00F WHERE TTSETT='*CNXV' AND TTELEM=E§COD8) CANALE_VENDITA, 
    (SELECT LEFT(TTELEM, 6)||TTDESC FROM SMEDATLIZ.TABEL00F WHERE TTSETT='BRY' AND TTELEM=E§CSME) SETTORE_MERC,
     E§INDI,	E§LOCA,	E§PROV,	E§CPAI,	E§COFI,	E§CPAE, 
	( SELECT MAX(DR.R5DREG) FROM SMEDATLIZ.C5RREGBL DR 
  	         WHERE DR.R5AZIE = '09' AND DR.R5TPCN = LIZ.E§TRAG 	AND  DR.R5SOGG = LIZ.E§CRAG )  DATAULTMOV,  
	( SELECT SUM(CASE WHEN R5DAAV = 'D' THEN R5IMPO ELSE 0-R5IMPO END ) FROM SMEDATLIZ.C5RREGBL DR 	
	         WHERE DR.R5AZIE = '09' AND DR.R5TPCN = LIZ.E§TRAG AND DR.R5SOGG = LIZ.E§CRAG) SALDOCONTABILE ,
	( SELECT SUM(CASE WHEN S5DAAV = 'D' THEN S5IMPO-S5IMPA ELSE 0-(S5IMPO-S5IMPA) END ) FROM SMEDATLIZ.C5RATE3L DR
	         WHERE DR.S5TPOG = 'CN' CONCAT LIZ.E§TRAG AND DR.S5CDOG = LIZ.E§CRAG) SALDOPARTITE,
	( SELECT COUNT(DISTINCT S5IDOJ) FROM SMEDATLIZ.C5RATE3L DR
	         WHERE DR.S5TPOG = 'CN' CONCAT LIZ.E§TRAG AND DR.S5CDOG = LIZ.E§CRAG) NUMEROPARTITE,
	( SELECT MAX(DR.D6DFAT) FROM SMEDATLIZ.V5STAT0X DR 
  	         WHERE D6TDOC='DA' and DR.D6TCDF = LIZ.E§TRAG 	AND  DR.D6CODF = LIZ.E§CRAG and D6ARTI<>'' )  DATAULTFATTURA 
FROM
	SMEDATLIZ.BRENTI0F LIZ
WHERE
	E§TRAG = 'CLI' 	AND 
	E§DFNV >= VARCHAR_FORMAT(CURRENT_DATE, 'YYYYMMDD')   
    --AND E§CPAI <> ''  
    --AND E§CPAE <> ''  -- Estero
	--AND E§STAT <= '15' 
--	AND E§STAT <> '90' 
--	AND e§cnaz<>'IT' 
--	AND NOT EXISTS (
--	    SELECT 1 FROM  SMEDATFDA.BRENTI0F FDA
--	    WHERE
--	             LIZ.E§TRAG = FDA.E§TRAG
--		     --AND LIZ.E§CPAI = FDA.E§CPAI
--		     AND LIZ.E§CPAE = FDA.E§CPAE  -- Estero
--		     AND FDA.E§DFNV >= VARCHAR_FORMAT(CURRENT_DATE, 'YYYYMMDD') 
--		     AND FDA.E§STAT <= '15')
UNION 
 SELECT  'FDA' COMPANY , 
    E§TRAG,	E§CRAG,	E§NMNE , 
    --E§AZIE,	
    E§DINV,	E§DFNV,	--E§LIVE,	
    E§RAGS, E§STAT,	E§ZONA,
    (SELECT LEFT(TTELEM, 5)||TTDESC FROM SMEDATFDA.TABEL00F WHERE TTSETT='PAG' AND TTELEM=E§COPA) PAGAMENTO,
    E§LIST LISTINO, 
    (SELECT LEFT(TTELEM, 5)||TTDESC FROM SMEDATFDA.TABEL00F WHERE TTSETT='*CNXV' AND TTELEM=E§COD8) CANALE_VENDITA, 
    (SELECT LEFT(TTELEM, 6)||TTDESC FROM SMEDATFDA.TABEL00F WHERE TTSETT='BRY' AND TTELEM=E§CSME) SETTORE_MERC,
     E§INDI,	E§LOCA,	E§PROV,	E§CPAI,	E§COFI,	E§CPAE, 
	( SELECT MAX(DR.R5DREG) FROM SMEDATFDA.C5RREGBL DR 
  	         WHERE DR.R5AZIE = '01' AND DR.R5TPCN = FDA.E§TRAG 	AND  DR.R5SOGG = FDA.E§CRAG )  DATAULTMOV,  
	( SELECT SUM(CASE WHEN R5DAAV = 'D' THEN R5IMPO ELSE 0-R5IMPO END ) FROM SMEDATFDA.C5RREGBL DR 	
	         WHERE DR.R5AZIE = '01' AND DR.R5TPCN = FDA.E§TRAG AND DR.R5SOGG = FDA.E§CRAG) SALDOCONTABILE ,
	( SELECT SUM(CASE WHEN S5DAAV = 'D' THEN S5IMPO-S5IMPA ELSE 0-(S5IMPO-S5IMPA) END ) FROM SMEDATFDA.C5RATE3L DR
	         WHERE DR.S5TPOG = 'CN' CONCAT FDA.E§TRAG AND DR.S5CDOG = FDA.E§CRAG) SALDOPARTITE,
	( SELECT COUNT(DISTINCT S5IDOJ) FROM SMEDATFDA.C5RATE3L DR
	         WHERE DR.S5TPOG = 'CN' CONCAT FDA.E§TRAG AND DR.S5CDOG = FDA.E§CRAG) NUMEROPARTITE,
	( SELECT MAX(DR.D6DFAT) FROM SMEDATFDA.V5STAT0X DR     
            WHERE D6TDOC='DA' and DR.D6TCDF = FDA.E§TRAG 	AND  DR.D6CODF = FDA.E§CRAG and D6ARTI<>'' )  DATAULTFATTURA  
FROM
	SMEDATFDA.BRENTI0F FDA
WHERE
	E§TRAG = 'CLI' 	AND 
	E§DFNV >= VARCHAR_FORMAT(CURRENT_DATE, 'YYYYMMDD')   
    --AND (E§CPAI <> ''   
--    AND E§CPAE IN      (
--'B65101255', 'CHE 110.222.212 MWST', '630921553', '182018393', '19310989673', 'B66800079', 'U25250803', 'B62303201', 'B76626977', 'U72269234', '29952301', '78-690-119',
--'187 484', '85534375514', 'A17085325', '96703680223', '62582056503', '84546850231', '8G05913L', '986901140', '8251084G', '556568142501', 'B07861362', '70340670777',
--'129367395', '823640085B01', '815571672', '84546850231', '22316807015', '70340670777', '807371361B01', 'B79492161', '26928699', '6636202', '28234642', '331816179',
--'A46569240', '769677060', '0415825340', '184048859', '279373945', '35206896', '220430231', '636086921', '05323802', '60353439110', 'A46103834', '100818662', '853473353B01',
--'263422560', 'B63022115', '23086285', '5855047367', '556583849601', '556519017901', '0822472205', '812131723', '769450883', '20381350297', '40003015277', '17131859', '173750205'
--)
	--AND E§STAT <= '15' 
 --   AND E§STAT <> '90'
	--AND E§CNAZ<>'IT' 
--	AND NOT EXISTS (
--	    SELECT 1 FROM  SMEDATLIZ.BRENTI0F LIZ
--	    WHERE
--	             FDA.E§TRAG = LIZ.E§TRAG
--		     --AND FDA.E§CPAI = LIZ.E§CPAI
--		     AND FDA.E§CPAE = LIZ.E§CPAE   -- Estero
--		     AND LIZ.E§DFNV >= VARCHAR_FORMAT(CURRENT_DATE, 'YYYYMMDD') 
--		     AND LIZ.E§STAT <= '15')
) 
SELECT * FROM CLICOM ORDER BY E§CPAI, COMPANY


